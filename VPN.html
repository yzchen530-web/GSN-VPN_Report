<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“Š VPN æ¯é€±æµé‡å ±è¡¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #2c3e50; }
    input[type="file"] { margin: 12px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f5f5f5; }
    .highlight { margin-top: 12px; font-weight: bold; color: #d35400; }
    .copyblock { margin-top: 16px; white-space: pre-line; font-family: monospace; }
  </style>
</head>
<body>
  <h1>ğŸ“Š VPN æ¯é€±æµé‡å ±è¡¨</h1>
  <br>ã€è«‹ä¸Šå‚³EyeSeeä¸‹è¼‰ä¹‹æª”æ¡ˆã€‘<br>
  <input type="file" id="upload" accept=".xlsx" />

  <div id="output"></div>

  <script>
    function formatDate(d) {
      return d.toLocaleDateString("zh-TW", { year: "numeric", month: "2-digit", day: "2-digit" });
    }
    function weekdayStr(d) {
      const map = { "Monday":"(ä¸€)","Tuesday":"(äºŒ)","Wednesday":"(ä¸‰)","Thursday":"(å››)","Friday":"(äº”)","Saturday":"(å…­)","Sunday":"(æ—¥)" };
      return map[d.toLocaleDateString("en-US",{weekday:"long"})];
    }

    document.getElementById('upload').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: "array" });

      // å›ºå®šè®€å–ç¬¬1å€‹å·¥ä½œè¡¨ (index=0)ï¼Œè·³éå‰9åˆ—
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(sheet, { defval:null, range:9 });

      if (!json.length) {
        document.getElementById("output").innerHTML = "<p class='highlight'>è®€ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªè¡¨æ ¼å…§å®¹ã€‚</p>";
        return;
      }

      // åµæ¸¬æ¬„ä½
      const sample = json[0];
      const timeCol = Object.keys(sample).find(k => k.includes("æ™‚é–“"));
      const inCol = Object.keys(sample).find(k => k.includes("æµå…¥"));
      const outCol = Object.keys(sample).find(k => k.includes("æµå‡º"));

      if (!timeCol || !inCol || !outCol) {
        document.getElementById("output").innerHTML = "<p class='highlight'>æ‰¾ä¸åˆ°æ™‚é–“/æµå…¥/æµå‡ºæ¬„ä½ã€‚</p>";
        return;
      }

      // æ•´ç†è³‡æ–™
      const rows = json.map(r => {
        const t = new Date(r[timeCol]);
        return {
          æ—¥æœŸ: formatDate(t),
          æµå…¥: Number(r[inCol]) / 1000,
          æµå‡º: Number(r[outCol]) / 1000
        };
      });

      // ä¾æ—¥æœŸåˆ†çµ„å¹³å‡
      const byDate = {};
      rows.forEach(r => {
        if (!byDate[r.æ—¥æœŸ]) byDate[r.æ—¥æœŸ] = [];
        byDate[r.æ—¥æœŸ].push(r);
      });

      const dailyAvg = Object.entries(byDate).map(([æ—¥æœŸ, group]) => {
        const avgIn = group.reduce((s,x)=>s+x.æµå…¥,0)/group.length;
        const avgOut = group.reduce((s,x)=>s+x.æµå‡º,0)/group.length;
        return { æ—¥æœŸ, å¹³å‡æµå…¥: avgIn.toFixed(2), å¹³å‡æµå‡º: avgOut.toFixed(2) };
      });

      // æ‰¾æœ€å¤§å¹³å‡æµå…¥/æµå‡º
      const maxIn = dailyAvg.reduce((a,b)=>parseFloat(a.å¹³å‡æµå…¥)>=parseFloat(b.å¹³å‡æµå…¥)?a:b);
      const maxOut = dailyAvg.reduce((a,b)=>parseFloat(a.å¹³å‡æµå‡º)>=parseFloat(b.å¹³å‡æµå‡º)?a:b);
      let maxDate, maxValue;
      if (parseFloat(maxIn.å¹³å‡æµå…¥) >= parseFloat(maxOut.å¹³å‡æµå‡º)) {
        maxDate = maxIn.æ—¥æœŸ; maxValue = maxIn.å¹³å‡æµå…¥;
      } else {
        maxDate = maxOut.æ—¥æœŸ; maxValue = maxOut.å¹³å‡æµå‡º;
      }

      // é€±å¹³å‡æµå…¥
      const weeklyAvgIn = (dailyAvg.reduce((s,r)=>s+parseFloat(r.å¹³å‡æµå…¥),0)/dailyAvg.length).toFixed(1);

      // è¼¸å‡ºè¡¨æ ¼
      let html = "<table><tr><th>æ—¥æœŸ</th><th>å¹³å‡æµå…¥ (Mbps)</th><th>å¹³å‡æµå‡º (Mbps)</th></tr>";
      dailyAvg.forEach(r=>{
        html += `<tr><td>${r.æ—¥æœŸ}</td><td>${r.å¹³å‡æµå…¥}</td><td>${r.å¹³å‡æµå‡º}</td></tr>`;
      });
      html += "</table>";

      // ğŸ”¥ æœ¬é€±æœ€é«˜æµé‡
      const dateObj = new Date(maxDate);
      html += `<div class="highlight">ğŸ”¥ æœ¬é€±æœ€é«˜æµé‡è½åœ¨${dateObj.toLocaleDateString("zh-TW",{month:"2-digit",day:"2-digit"})}${weekdayStr(dateObj)}æµé‡ç‚º ${maxValue} Mbps</div>`;
      html += `<div>ğŸ“… é€±å¹³å‡æµé‡ç‚º ${weeklyAvgIn} Mbps (${(weeklyAvgIn/6).toFixed(1)}%)</div>`;

      // ğŸ“‹ å–®ç¨è¼¸å‡º(è¤‡è£½ç”¨)
      html += `<div class="copyblock">ğŸ“‹ å–®ç¨è¼¸å‡º(è¤‡è£½ç”¨)ï¼š\nå¹³å‡æµå…¥ (Mbps)\n`;
      dailyAvg.forEach(r=>{ html += ` ${r.å¹³å‡æµå…¥}\n`; });
      html += `å¹³å‡æµå‡º (Mbps)\n`;
      dailyAvg.forEach(r=>{ html += ` ${r.å¹³å‡æµå‡º}\n`; });
      html += `</div>`;

      document.getElementById("output").innerHTML = html;
    });
  </script>
</body>
</html>